#!/usr/bin/env node
var execSync = require('child_process').execSync;
var path = require('path');
var fs = require('fs-extra');
var argv = require('optimist').argv;
var semver = require('semver');
var cwd = process.cwd();
var defaultOption = {
  cwd: cwd,
  stdio: 'inherit'
};
var firstArg = argv['_'][0];
var HOME = process.env.HOME;
var gsyncDir = path.join(HOME, '.gsync');
var stat = fs.statSync(gsyncDir);
var gsyncFile;
var targetVersion;
var privateName;
if (!stat.isFlie) {
  if (semver.valid(targetVersion)) {
    console.error('第一个参数必须是你的名字，用来作为个人分支名')
    return false;
  }
  fs.mkdirsSync(gsyncDir);
  gsyncFile = path.join(gsyncDir, 'config.json');
  fs.writeJsonSync(gsyncFile, '{name: '+ firstArg +'}', 'utf8');
  privateName = firstArg;
  targetVersion = argv['_'][1];
} else {
  gsyncFile = path.join(gsyncDir, 'config.json');
  privateName = fs.readJsonSync(gsyncFile).name;
  targetVersion = argv['_'][0];
}

if (!semver.valid(targetVersion)) {
  console.error('请输出daily版本号');
  process.exit(0);
}
var curBranch = execSync('git symbolic-ref HEAD').toString().trim().replace('refs/heads/','');
var privateBranch = 'dev/' + privateName + '-' + targetVersion;
var dailyBranch = 'daily/' + targetVersion;

if (curBranch == privateBranch || curBranch == dailyBranch) {
  console.error('当前分支为个人分支或者daily分支，不是开发分支');
  process.exit(0);
}
execSync('git add .');
try {
  execSync('git commit -am "git sync"');
} catch (e) {

}
execSync('rm -rf build');
try {
  execSync('git checkout ' + privateBranch);
} catch(e) {
  execSync('git checkout -b ' + privateBranch);
  execSync('git push -u -f origin ' + privateBranch);
}
execSync('git pull');
execSync('git merge ' + curBranch, defaultOption);
execSync('git add .');
try {
  execSync('git commit -am "merge ' + curBranch + '"');
} catch (e) {

}
execSync('git push -u origin ' + privateBranch);
execSync('git checkout master');
execSync('git pull');
execSync('git checkout ' + dailyBranch);
execSync('git pull');
execSync('git merge ' + privateBranch, defaultOption);
// execSync('git push -u origin ' + dailyBranch);
